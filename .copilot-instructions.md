# Tab Group Feature - Architectural Design

## 1. High-Level Component Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        Presentation Layer                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────┐      ┌────────────────────────────┐       │
│  │  TabController   │◄─────┤  TabGroupController        │       │
│  │  (existing)      │      │  - Group UI management     │       │
│  │                  │      │  - Context menu handling   │       │
│  └────────┬─────────┘      │  - Visual group rendering  │       │
│           │                └────────────┬───────────────┘       │
│           │                             │                        │
│           │                ┌────────────▼───────────────┐       │
│           │                │  TabGroupContextMenu       │       │
│           │                │  - Create group            │       │
│           │                │  - Add to existing group   │       │
│           │                │  - Remove from group       │       │
│           │                │  - Rename/Edit group       │       │
│           │                └────────────────────────────┘       │
│           │                                                      │
└───────────┼──────────────────────────────────────────────────────┘
            │
┌───────────▼──────────────────────────────────────────────────────┐
│                         Service Layer                             │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌──────────────────┐      ┌────────────────────────────┐       │
│  │  TabService      │◄─────┤  TabGroupService           │       │
│  │  (existing)      │      │  - Business logic          │       │
│  └──────────────────┘      │  - Group lifecycle         │       │
│                             │  - Tab-group association   │       │
│                             │  - Validation rules        │       │
│                             │  - Collapse/Expand groups  │       │
│                             └────────────┬───────────────┘       │
│                                          │                        │
└──────────────────────────────────────────┼────────────────────────┘
                                           │
┌──────────────────────────────────────────▼────────────────────────┐
│                        Domain Layer                                │
├───────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────────────┐      ┌────────────────────────────┐        │
│  │  Tab             │      │  TabGroup                  │        │
│  │  (existing)      │      │  - id: int                 │        │
│  │  + groupId       │◄─────┤  - name: String            │        │
│  │                  │      │  - color: TabGroupColor    │        │
│  └──────────────────┘      │  - tabIds: List<Integer>   │        │
│                             │  - isCollapsed: boolean    │        │
│  ┌──────────────────┐      │  - createdAt: Timestamp    │        │
│  │  TabGroupColor   │◄─────┤  - sessionId: String       │        │
│  │  (enum)          │      │  - position: int           │        │
│  │  - BLUE          │      └────────────────────────────┘        │
│  │  - RED           │                                             │
│  │  - YELLOW        │      ┌────────────────────────────┐        │
│  │  - GREEN         │      │  TabGroupTab               │        │
│  │  - PINK          │      │  (join entity)             │        │
│  │  - PURPLE        │      │  - groupId: int            │        │
│  │  - CYAN          │      │  - tabId: int              │        │
│  │  - ORANGE        │      │  - position: int           │        │
│  │  - GRAY          │      │  - addedAt: Timestamp      │        │
│  └──────────────────┘      └────────────────────────────┘        │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
                                           │
┌──────────────────────────────────────────▼────────────────────────┐
│                      Persistence Layer                             │
├───────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────────────┐      ┌────────────────────────────┐        │
│  │  TabRepository   │      │  TabGroupRepository        │        │
│  │  (existing)      │      │  - CRUD operations         │        │
│  │                  │      │  - findBySessionId()       │        │
│  └──────────────────┘      │  - findGroupsWithTabs()    │        │
│                             │  - findActiveGroups()      │        │
│                             │  - deleteEmptyGroups()     │        │
│                             └────────────┬───────────────┘        │
│                                          │                         │
│                             ┌────────────▼───────────────┐        │
│                             │  TabGroupTabRepository     │        │
│                             │  - addTabToGroup()         │        │
│                             │  - removeTabFromGroup()    │        │
│                             │  - findTabsByGroupId()     │        │
│                             │  - findGroupsByTabId()     │        │
│                             │  - reorderTabsInGroup()    │        │
│                             └────────────────────────────┘        │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
                                           │
┌──────────────────────────────────────────▼────────────────────────┐
│                        Database Schema                             │
├───────────────────────────────────────────────────────────────────┤
│                                                                    │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │  tab_groups                                               │    │
│  │  - id (PK, INTEGER, AUTO_INCREMENT)                       │    │
│  │  - name (VARCHAR(100))                                    │    │
│  │  - color (VARCHAR(20))                                    │    │
│  │  - is_collapsed (BOOLEAN, DEFAULT false)                 │    │
│  │  - session_id (VARCHAR(255))                             │    │
│  │  - position (INTEGER)                                     │    │
│  │  - created_at (TIMESTAMP)                                │    │
│  │  - updated_at (TIMESTAMP)                                │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │  tab_group_tabs                                           │    │
│  │  - id (PK, INTEGER, AUTO_INCREMENT)                       │    │
│  │  - group_id (FK -> tab_groups.id)                        │    │
│  │  - tab_id (INTEGER)                                       │    │
│  │  - position (INTEGER)                                     │    │
│  │  - added_at (TIMESTAMP)                                   │    │
│  │  - UNIQUE(group_id, tab_id)                              │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │  tabs (modified)                                          │    │
│  │  - ... existing columns ...                              │    │
│  │  + group_id (FK -> tab_groups.id, NULLABLE)              │    │
│  └──────────────────────────────────────────────────────────┘    │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## 2. New Classes/Components Needed

### 2.1 Model Layer (4 classes)

1. **TabGroup**
2. **TabGroupColor** (enum)
3. **TabGroupTab** (join entity)
4. **GroupedTabState** (DTO for UI state)

### 2.2 Repository Layer (2 classes)

5. **TabGroupRepository**
6. **TabGroupTabRepository**

### 2.3 Service Layer (1 class)

7. **TabGroupService**

### 2.4 Controller Layer (2 classes)

8. **TabGroupController**
9. **TabGroupContextMenu**

### 2.5 View Components (3 classes)

10. **TabGroupIndicator** (visual component)
11. **TabGroupHeaderView** (collapsed group header)
12. **TabGroupDialog** (create/edit group)

---

## 3. Class Responsibilities

### 3.1 Model Layer

#### **TabGroup**
**Location:** `com.example.nexus.model.TabGroup`

**Responsibilities:**
- Represent a tab group entity with all properties
- Store group metadata (id, name, color)
- Track group state (collapsed/expanded)
- Maintain session association for persistence
- Track position in tab bar for ordering

**Properties:**
- `id: int` - Unique identifier
- `name: String` - User-defined group name
- `color: TabGroupColor` - Visual color indicator
- `isCollapsed: boolean` - Collapsed state
- `sessionId: String` - Session association
- `position: int` - Order in tab bar
- `createdAt: Timestamp` - Creation timestamp
- `updatedAt: Timestamp` - Last modification timestamp

**Methods:**
- Standard getters/setters
- `toString()` for debugging
- No business logic (pure data model)

---

#### **TabGroupColor** (enum)
**Location:** `com.example.nexus.model.TabGroupColor`

**Responsibilities:**
- Define available group colors matching Chrome's palette
- Provide color hex codes for UI rendering
- Provide color names for display

**Values:**
- `BLUE("#4285F4", "Blue")`
- `RED("#EA4335", "Red")`
- `YELLOW("#FBBC04", "Yellow")`
- `GREEN("#34A853", "Green")`
- `PINK("#FF6D9A", "Pink")`
- `PURPLE("#A142F4", "Purple")`
- `CYAN("#24C1E0", "Cyan")`
- `ORANGE("#FA903E", "Orange")`
- `GRAY("#9AA0A6", "Gray")`

**Methods:**
- `getHexCode(): String` - Returns color hex code
- `getDisplayName(): String` - Returns user-friendly name
- `fromString(String): TabGroupColor` - Parse from stored value

---

#### **TabGroupTab**
**Location:** `com.example.nexus.model.TabGroupTab`

**Responsibilities:**
- Represent many-to-many relationship between tabs and groups
- Track when a tab was added to a group
- Maintain tab order within the group
- Enable historical tracking even after tabs close

**Properties:**
- `id: int` - Unique identifier
- `groupId: int` - Foreign key to TabGroup
- `tabId: int` - Reference to tab (not FK - survives tab deletion)
- `position: int` - Order within group
- `addedAt: Timestamp` - When tab joined group

**Methods:**
- Standard getters/setters
- No business logic

---

#### **GroupedTabState**
**Location:** `com.example.nexus.model.GroupedTabState`

**Responsibilities:**
- Data Transfer Object for UI layer
- Combine group and tab information for rendering
- Avoid exposing repository details to UI
- Provide computed properties for display

**Properties:**
- `group: TabGroup` - The group entity
- `activeTabs: List<Tab>` - Currently open tabs in group
- `totalTabCount: int` - All tabs (including closed ones)
- `isAllTabsClosed: boolean` - Computed state

**Methods:**
- `hasOpenTabs(): boolean`
- `getFirstTab(): Tab` - For favicon/title when collapsed

---

### 3.2 Repository Layer

#### **TabGroupRepository**
**Location:** `com.example.nexus.repository.TabGroupRepository`
**Extends:** `BaseRepository<TabGroup>`

**Responsibilities:**
- CRUD operations for TabGroup entities
- Query groups by session
- Find active (non-empty) groups
- Manage group lifecycle in database
- Handle SQL for tab_groups table

**Methods:**
- `findAll(): List<TabGroup>` - Get all groups
- `findById(int): TabGroup` - Get specific group
- `save(TabGroup): void` - Insert new group
- `update(TabGroup): void` - Update existing group
- `delete(int): void` - Remove group
- `findBySessionId(String): List<TabGroup>` - Session-specific groups
- `findActiveGroups(String sessionId): List<TabGroup>` - Groups with open tabs
- `deleteEmptyGroups(String sessionId): void` - Cleanup groups with no tabs
- `updatePosition(int groupId, int position): void` - Reorder groups

**Database Interaction:**
- Maps to `tab_groups` table
- Handles all SQL prepared statements
- Manages database connections via DatabaseManager

---

#### **TabGroupTabRepository**
**Location:** `com.example.nexus.repository.TabGroupTabRepository`
**Extends:** `BaseRepository<TabGroupTab>`

**Responsibilities:**
- Manage tab-group associations
- Handle adding/removing tabs from groups
- Query tabs by group and groups by tab
- Maintain tab ordering within groups
- Track historical associations

**Methods:**
- `findAll(): List<TabGroupTab>` - All associations
- `findById(int): TabGroupTab` - Specific association
- `save(TabGroupTab): void` - Create association
- `update(TabGroupTab): void` - Update association
- `delete(int): void` - Remove association
- `addTabToGroup(int tabId, int groupId): void` - Add tab to group
- `removeTabFromGroup(int tabId, int groupId): void` - Remove tab from group
- `findTabsByGroupId(int groupId): List<Integer>` - Get all tab IDs in group
- `findGroupsByTabId(int tabId): List<Integer>` - Get groups containing tab
- `reorderTabsInGroup(int groupId, List<Integer> tabIds): void` - Reorder tabs
- `deleteByTabId(int tabId): void` - Cleanup when tab is permanently deleted
- `deleteByGroupId(int groupId): void` - Cleanup when group is deleted
- `countActiveTabsInGroup(int groupId): int` - Count currently open tabs

**Database Interaction:**
- Maps to `tab_group_tabs` table
- Enforces unique constraint (tab can be in only one group at a time)
- Handles cascade operations

---

### 3.3 Service Layer

#### **TabGroupService**
**Location:** `com.example.nexus.service.TabGroupService`

**Responsibilities:**
- Business logic for tab group operations
- Coordinate between repositories
- Validate group operations
- Manage group lifecycle (create, update, delete)
- Handle tab membership changes
- Implement collapse/expand behavior
- Ensure data consistency

**Constructor:**
- `TabGroupService(DIContainer container)` - Inject dependencies

**Dependencies:**
- `TabGroupRepository` - Group persistence
- `TabGroupTabRepository` - Association persistence
- `TabRepository` - Tab data access (for validation)

**Methods:**

*Group Management:*
- `createGroup(String name, TabGroupColor color, String sessionId): TabGroup`
  - Create new group with validation
  - Assign next available position
- `updateGroup(TabGroup group): void` - Update group properties
- `deleteGroup(int groupId): void` - Remove group and associations
- `renameGroup(int groupId, String newName): void` - Change group name
- `changeGroupColor(int groupId, TabGroupColor color): void` - Update color
- `getGroup(int groupId): TabGroup` - Retrieve specific group
- `getAllGroups(String sessionId): List<TabGroup>` - Get all groups for session

*Tab Management:*
- `addTabToGroup(int tabId, int groupId): void`
  - Add tab to group
  - Remove from previous group if exists
  - Update tab entity with groupId
- `removeTabFromGroup(int tabId): void`
  - Remove tab from current group
  - Update tab entity (groupId = null)
  - Don't delete group (persist even when empty)
- `moveTabBetweenGroups(int tabId, int fromGroupId, int toGroupId): void`
- `getTabsInGroup(int groupId): List<Tab>` - Get all tabs (active and inactive)
- `getActiveTabsInGroup(int groupId): List<Tab>` - Only currently open tabs

*State Management:*
- `collapseGroup(int groupId): void` - Collapse group visually
- `expandGroup(int groupId): void` - Expand group
- `toggleGroupCollapse(int groupId): void` - Toggle state
- `isGroupCollapsed(int groupId): boolean` - Check state

*Query & Reporting:*
- `getGroupedTabState(int groupId): GroupedTabState` - Get UI state
- `getAllGroupedTabStates(String sessionId): List<GroupedTabState>` - All groups with state
- `getGroupForTab(int tabId): TabGroup` - Find tab's group (if any)
- `hasOpenTabs(int groupId): boolean` - Check if any tabs are open

*Cleanup:*
- `cleanupClosedTabAssociations(String sessionId): void`
  - Remove associations for tabs that are permanently deleted
  - Keep associations for tabs that are just closed (for reopen functionality)

**Validation Rules:**
- Group name cannot be empty (max 100 chars)
- Color must be valid TabGroupColor
- Tab can only be in one group at a time
- Cannot add same tab to group twice
- Group persists even with zero tabs

---

### 3.4 Controller Layer

#### **TabGroupController**
**Location:** `com.example.nexus.controller.TabGroupController`

**Responsibilities:**
- Coordinate UI updates for tab grouping
- Handle user interactions with groups
- Manage visual representation of groups
- Synchronize tab bar with group state
- Integrate with existing TabController
- Respond to service-layer events

**Constructor:**
- `TabGroupController(DIContainer container, TabController tabController)`

**Dependencies:**
- `TabGroupService` - Business logic
- `TabController` - Tab management coordination
- `SettingsService` - User preferences

**Methods:**

*Initialization:*
- `initialize(): void` - Setup event listeners
- `restoreGroupsFromSession(String sessionId): void` - Load saved groups

*Group Creation:*
- `showCreateGroupDialog(List<Integer> tabIds): void` - Show group creation UI
- `createGroupWithTabs(String name, TabGroupColor color, List<Integer> tabIds): void`
- `createGroupFromTab(int tabId): void` - Quick group creation

*Visual Management:*
- `renderGroupIndicator(int tabId, TabGroup group): void` - Add color indicator to tab
- `removeGroupIndicator(int tabId): void` - Remove indicator
- `renderCollapsedGroup(TabGroup group): void` - Show group header when collapsed
- `updateGroupVisuals(int groupId): void` - Refresh all visual elements
- `highlightGroup(int groupId): void` - Visual feedback on hover

*Tab Operations:*
- `addTabToGroup(int tabId, int groupId): void` - Add tab with UI update
- `removeTabFromGroup(int tabId): void` - Remove tab with UI update
- `moveTabToGroup(int tabId, int targetGroupId): void` - Move between groups

*Group Operations:*
- `collapseGroup(int groupId): void` - Collapse with animation
- `expandGroup(int groupId): void` - Expand with animation
- `deleteGroup(int groupId): void` - Remove group with confirmation
- `editGroup(int groupId): void` - Show edit dialog

*Event Handlers:*
- `onTabClosed(int tabId): void` - Handle tab closure (keep group)
- `onTabCreated(int tabId, Integer groupId): void` - Add to group if specified
- `onTabDragStart(int tabId): void` - Prepare for drag-to-group
- `onTabDragEnd(int tabId, int targetIndex): void` - Handle reordering

*Context Menu Integration:*
- `attachContextMenuToTab(javafx.scene.control.Tab tab): void` - Add right-click menu

---

#### **TabGroupContextMenu**
**Location:** `com.example.nexus.controller.TabGroupContextMenu`

**Responsibilities:**
- Provide right-click menu for tab grouping
- Present available group actions
- Handle menu selection events
- Dynamic menu based on tab state (grouped vs ungrouped)

**Constructor:**
- `TabGroupContextMenu(TabGroupController controller, TabGroupService service)`

**Methods:**

*Menu Construction:*
- `buildMenuForTab(int tabId): ContextMenu` - Build context menu
- `buildGroupSubmenu(String sessionId): Menu` - "Add to group" submenu
- `buildColorSubmenu(): Menu` - Color selection submenu

*Menu Items:*
- Create menu items for:
  - "Add Tab to New Group..." - Create group dialog
  - "Add to Group" submenu - List existing groups
  - "Remove from Group" - If tab is grouped
  - "Rename Group" - If tab is grouped
  - "Change Group Color" - If tab is grouped
  - "Ungroup" - If tab is grouped
  - "Delete Group" - If tab is grouped (with confirmation)

*Event Handling:*
- `onCreateNewGroup(int tabId): void` - Handle new group creation
- `onAddToExistingGroup(int tabId, int groupId): void` - Add to group
- `onRemoveFromGroup(int tabId): void` - Remove from group
- `onRenameGroup(int groupId): void` - Show rename dialog
- `onChangeColor(int groupId, TabGroupColor color): void` - Update color
- `onDeleteGroup(int groupId): void` - Delete with confirmation

**Dynamic Behavior:**
- Menu changes based on whether tab is in a group
- Shows only relevant actions
- Lists all available groups for adding
- Keyboard shortcuts support

---

### 3.5 View Components

#### **TabGroupIndicator**
**Location:** `com.example.nexus.view.components.TabGroupIndicator`
**Extends:** `Region` or `Pane`

**Responsibilities:**
- Visual color indicator for grouped tabs
- Render color bar/dot on tab
- Respond to theme changes
- Animate color transitions
- Provide hover effects

**Constructor:**
- `TabGroupIndicator(TabGroupColor color)`

**Properties:**
- `color: ObjectProperty<TabGroupColor>` - Bindable color
- `thickness: double` - Indicator thickness
- `position: IndicatorPosition` - Top/Bottom/Side

**Methods:**
- `setColor(TabGroupColor color): void` - Update color with animation
- `setThickness(double thickness): void` - Adjust indicator size
- `updateTheme(boolean isDark): void` - Adapt to theme
- `createAnimation(): Transition` - Smooth color change

**Styling:**
- CSS class: `tab-group-indicator`
- Supports custom styles via CSS
- Renders as colored bar at bottom/top of tab

---

#### **TabGroupHeaderView**
**Location:** `com.example.nexus.view.components.TabGroupHeaderView`
**Extends:** `HBox` or custom `Control`

**Responsibilities:**
- Display collapsed group as single item in tab bar
- Show group name, color, and tab count
- Provide expand/collapse toggle
- Display first tab's favicon
- Handle click to expand

**Constructor:**
- `TabGroupHeaderView(TabGroup group, GroupedTabState state)`

**Components:**
- Color indicator (left border or dot)
- Favicon from first tab
- Group name label
- Tab count badge (e.g., "(3)")
- Expand/collapse button
- Close button

**Methods:**
- `updateState(GroupedTabState state): void` - Refresh display
- `setExpanded(boolean expanded): void` - Toggle state
- `setOnExpand(EventHandler<ActionEvent>): void` - Expand handler
- `setOnClose(EventHandler<ActionEvent>): void` - Close handler
- `updateFavicon(String url): void` - Update icon

**Styling:**
- CSS class: `tab-group-header`
- Compact horizontal layout
- Hover effects
- Color-coded border/background

---

#### **TabGroupDialog**
**Location:** `com.example.nexus.view.dialogs.TabGroupDialog`
**Extends:** `Dialog<TabGroup>`

**Responsibilities:**
- Create/edit group dialog UI
- Collect group name input
- Color picker for group color
- Validation feedback
- OK/Cancel handling

**Constructor:**
- `TabGroupDialog(TabGroup existingGroup)` - Edit mode
- `TabGroupDialog()` - Create mode

**Components:**
- TextField for group name
- Color selector (buttons or picker)
- Preview pane showing how group will look
- Error label for validation messages
- OK and Cancel buttons

**Methods:**
- `showAndWait(): Optional<TabGroup>` - Show dialog modally
- `validate(): boolean` - Check inputs
- `getGroupName(): String` - Get user input
- `getSelectedColor(): TabGroupColor` - Get chosen color
- `populateFields(TabGroup group): void` - Load existing group data

**Validation:**
- Name not empty
- Name max 100 characters
- Color selected
- Show validation errors inline

---

## 4. Integration Points

### 4.1 Modification to Existing Tab Model
**File:** `com.example.nexus.model.Tab`

**Changes Needed:**
- Add property: `groupId: Integer` (nullable)
- Add getter/setter for `groupId`
- Update constructors if needed

**Database Migration:**
```sql
ALTER TABLE tabs ADD COLUMN group_id INTEGER;
ALTER TABLE tabs ADD FOREIGN KEY (group_id) REFERENCES tab_groups(id) ON DELETE SET NULL;
```

---

### 4.2 Integration with TabController
**File:** `com.example.nexus.controller.TabController`

**Changes Needed:**
- Inject `TabGroupController` as dependency
- Call `tabGroupController.onTabCreated()` when new tab is created
- Call `tabGroupController.onTabClosed()` when tab is closed
- Call `tabGroupController.attachContextMenuToTab()` for right-click support
- Coordinate tab reordering with group boundaries

**Methods to Add/Modify:**
- `createNewTab()` - Notify TabGroupController
- `closeTab()` - Notify TabGroupController
- `setupTabContextMenu()` - Include group options

---

### 4.3 Integration with DIContainer
**File:** `com.example.nexus.core.DIContainer`

**No Changes Required:**
- Existing `getOrCreate()` mechanism automatically handles new services
- TabGroupService, TabGroupRepository will be auto-instantiated

**Registration (in BrowserApplication or initialization):**
- Container will auto-wire dependencies
- No explicit registration needed due to reflection-based DI

---

### 4.4 Database Schema Changes
**File:** `src/main/resources/com/example/nexus/db/init.sql` (or migration script)

**New Tables:**

```sql
-- Tab Groups table
CREATE TABLE IF NOT EXISTS tab_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    color VARCHAR(20) NOT NULL,
    is_collapsed BOOLEAN DEFAULT 0,
    session_id VARCHAR(255),
    position INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tab-Group association table
CREATE TABLE IF NOT EXISTS tab_group_tabs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id INTEGER NOT NULL,
    tab_id INTEGER NOT NULL,
    position INTEGER,
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (group_id) REFERENCES tab_groups(id) ON DELETE CASCADE,
    UNIQUE(group_id, tab_id)
);

-- Index for performance
CREATE INDEX idx_tab_group_tabs_group_id ON tab_group_tabs(group_id);
CREATE INDEX idx_tab_group_tabs_tab_id ON tab_group_tabs(tab_id);
CREATE INDEX idx_tab_groups_session_id ON tab_groups(session_id);
```

---

## 5. Workflow Examples

### 5.1 Create New Group from Tab
**User Action:** Right-click tab → "Add Tab to New Group"

**Flow:**
1. User triggers context menu on Tab A
2. `TabGroupContextMenu.onCreateNewGroup(tabA.id)` called
3. `TabGroupController.showCreateGroupDialog([tabA.id])` displays dialog
4. User enters name "Work" and selects BLUE color
5. `TabGroupController.createGroupWithTabs("Work", BLUE, [tabA.id])`
6. Calls `TabGroupService.createGroup("Work", BLUE, sessionId)`
   - Creates TabGroup entity (id=1, name="Work", color=BLUE)
   - Saves to DB via `TabGroupRepository.save()`
7. Calls `TabGroupService.addTabToGroup(tabA.id, group.id)`
   - Creates TabGroupTab association
   - Updates Tab entity with groupId=1
8. `TabGroupController.renderGroupIndicator(tabA.id, group)`
   - Adds blue color bar to tab
9. UI updates: Tab A now shows blue indicator

---

### 5.2 Add Tab to Existing Group
**User Action:** Right-click Tab B → "Add to Group" → "Work"

**Flow:**
1. Context menu shows existing groups
2. User selects "Work" group
3. `TabGroupContextMenu.onAddToExistingGroup(tabB.id, workGroup.id)`
4. `TabGroupController.addTabToGroup(tabB.id, workGroup.id)`
5. `TabGroupService.addTabToGroup(tabB.id, workGroup.id)`
   - If Tab B was in another group, removes it first
   - Creates association in `tab_group_tabs`
   - Updates Tab entity
6. UI updates: Tab B shows blue indicator
7. Tabs A and B are now visually grouped

---

### 5.3 Collapse Group
**User Action:** Right-click grouped tab → "Collapse Group"

**Flow:**
1. User triggers collapse on Tab A (in "Work" group)
2. `TabGroupController.collapseGroup(workGroup.id)`
3. `TabGroupService.collapseGroup(workGroup.id)`
   - Updates `is_collapsed=true` in DB
4. `TabGroupController.renderCollapsedGroup(workGroup)`
   - Hides Tab A and Tab B from tab bar
   - Creates `TabGroupHeaderView` showing:
     - Blue indicator
     - "Work"
     - "(2)" tab count
     - Favicon from Tab A
5. Tab bar now shows compact group header instead of individual tabs

---

### 5.4 Expand Group
**User Action:** Click on collapsed group header

**Flow:**
1. User clicks "Work (2)" header
2. `TabGroupController.expandGroup(workGroup.id)`
3. `TabGroupService.expandGroup(workGroup.id)`
   - Updates `is_collapsed=false` in DB
4. `TabGroupController.updateGroupVisuals(workGroup.id)`
   - Removes group header
   - Shows Tab A and Tab B individually
   - Both display blue group indicators
5. Individual tabs visible again

---

### 5.5 Close Tab in Group
**User Action:** Close Tab A (which is in "Work" group)

**Flow:**
1. User closes Tab A via close button
2. `TabController.closeTab(tabA)` called
3. `TabGroupController.onTabClosed(tabA.id)` notified
4. Tab removed from UI
5. Group association **persists** in DB
   - `tab_group_tabs` still has entry for Tab A
   - Allows reopening tab back into same group later
6. If group is collapsed:
   - Header updates to show "(1)" instead of "(2)"
   - Uses Tab B's favicon now
7. "Work" group still exists with Tab B active

---

### 5.6 Reopen Closed Tab in Group
**User Action:** Ctrl+Shift+T (reopen closed tab)

**Flow:**
1. Tab A reopened by TabController
2. `TabController` restores Tab entity from DB
3. Tab entity has `groupId=1` (Work group)
4. `TabGroupController.onTabCreated(tabA.id, groupId=1)`
5. `TabGroupController.renderGroupIndicator(tabA.id, workGroup)`
6. Tab A reappears with blue indicator
7. Automatically rejoins "Work" group

---

### 5.7 Delete Group
**User Action:** Right-click grouped tab → "Delete Group"

**Flow:**
1. User selects "Delete Group" from context menu
2. Confirmation dialog appears: "Remove group 'Work'? Tabs will remain open."
3. User confirms
4. `TabGroupController.deleteGroup(workGroup.id)`
5. `TabGroupService.deleteGroup(workGroup.id)`
   - Deletes from `tab_groups` table
   - CASCADE deletes all `tab_group_tabs` entries
   - Updates all Tab entities (groupId set to null)
6. `TabGroupController.removeGroupIndicator()` for each tab
7. Tabs A and B lose blue indicators
8. Tabs remain open, just ungrouped

---

## 6. Key Design Decisions

### 6.1 Persistence Strategy
**Decision:** Groups persist even when all tabs are closed

**Rationale:**
- Matches Chrome behavior
- Allows users to reopen tabs into existing groups
- Preserves user's organizational intent
- Groups are cheap to store (minimal data)

**Implementation:**
- Don't auto-delete empty groups
- Provide manual cleanup option in settings
- Show empty groups in session restore

---

### 6.2 Single Group Membership
**Decision:** A tab can only be in one group at a time

**Rationale:**
- Simpler mental model for users
- Matches Chrome's implementation
- Avoids complex UI scenarios
- Easier database constraints

**Implementation:**
- UNIQUE constraint on (group_id, tab_id)
- When adding to new group, automatically remove from old group
- No "shared tabs" concept

---

### 6.3 Tab Identity
**Decision:** Use tab IDs, not runtime references

**Rationale:**
- Tabs can be closed and reopened
- Persistence across sessions
- Allows historical tracking
- Decouples UI from data layer

**Implementation:**
- TabGroupTab stores `tabId` as integer, not FK
- Service layer resolves IDs to Tab objects
- Handle missing tabs gracefully (deleted permanently)

---

### 6.4 Visual Indicators
**Decision:** Color bar at bottom of tab + group header for collapsed state

**Rationale:**
- Non-intrusive visual grouping
- Clear color association
- Doesn't clutter tab bar when expanded
- Compact representation when collapsed

**Implementation:**
- `TabGroupIndicator` renders 3px colored bar
- `TabGroupHeaderView` for collapsed state
- Smooth expand/collapse animations

---

### 6.5 Context Menu Integration
**Decision:** Right-click menu for all group operations

**Rationale:**
- Discoverable for users familiar with Chrome
- Doesn't clutter main UI
- Contextual actions based on tab state
- Allows quick group management

**Implementation:**
- `TabGroupContextMenu` builds dynamic menus
- Integrates with existing TabController context menu
- Shows relevant options based on group state

---

## 7. Non-Functional Considerations

### 7.1 Performance
- Groups load with session (one query per session)
- Associations cached in service layer
- UI updates batched for multiple tabs
- Lazy loading of group states

### 7.2 Usability
- Intuitive right-click workflow
- Visual feedback on all actions
- Undo/redo support (future enhancement)
- Keyboard shortcuts for power users

### 7.3 Maintainability
- Clean separation of concerns (MVC pattern)
- Existing architecture patterns followed
- Comprehensive logging in service layer
- Minimal changes to existing code

### 7.4 Extensibility
- Easy to add new group properties (icons, descriptions)
- Can extend to tab group folders (nested groups)
- Can add group-level settings (auto-collapse, pin)
- Can integrate with bookmarks/sessions

---

## 8. Migration Path

### Phase 1: Foundation
1. Create model classes (TabGroup, TabGroupColor, TabGroupTab)
2. Create repository classes
3. Database migration (create tables)
4. Create TabGroupService with core logic

### Phase 2: Basic UI
5. Create TabGroupIndicator component
6. Create TabGroupDialog
7. Implement TabGroupController basic operations
8. Integrate with TabController (creation/closure)

### Phase 3: Advanced UI
9. Create TabGroupHeaderView
10. Implement collapse/expand
11. Create TabGroupContextMenu
12. Add animations and polish

### Phase 4: Polish
13. Add keyboard shortcuts
14. Session persistence testing
15. Performance optimization
16. User documentation

---

## 9. Testing Strategy

### Unit Tests
- TabGroupService: group creation, tab management, validation
- Repositories: CRUD operations, queries
- TabGroupColor: parsing, validation

### Integration Tests
- Service + Repository: persistence workflows
- Controller + Service: UI state synchronization
- Session restore: group persistence across restarts

### UI Tests
- Context menu behavior
- Drag-and-drop (future)
- Collapse/expand animations
- Visual indicator rendering

---

## 10. Summary

This design provides a robust, Chrome-like tab grouping feature for your JavaFX browser. It follows your existing architectural patterns (Service/Repository/Model layers, DIContainer dependency injection) and integrates cleanly with the current TabController and TabService.

**Key Features:**
- ✅ Groups persist after tabs close
- ✅ Tabs can be added via right-click
- ✅ Each group has name, color, and tab list
- ✅ Groups can be collapsed/expanded
- ✅ Clean separation of concerns
- ✅ Minimal changes to existing code
- ✅ Extensible for future enhancements

**Next Steps:**
When you're ready to implement, start with Phase 1 (foundation) and progressively build up through Phase 4. Each phase delivers incremental value and can be tested independently.

